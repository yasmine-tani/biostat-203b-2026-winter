---
title: "biostat203bhw3"
format: html
editor: visual
author: Yasmine Tani; UID 406579988
---

# Biostatistics 203B - Homework 3

```{r}
sessionInfo()
```

```{r}
#loading necessary libraries
library(arrow)
library(gtsummary)
library(memuse)
library(pryr)
library(R.utils)
library(tidyverse)
library(stringr)
library(ggplot2)
```

```{r}
memuse::Sys.meminfo()
```

## Q1 Visualizing Patient Trajectory

### 1.1 ADT History (Admission-Discharge-Transfer)

```{r}
#patient dem for title, have to compute age manually according to TA
patient_info <- read_csv("mimic/hosp/patients.csv.gz",
            col_select = c(subject_id, anchor_age, anchor_year, gender)) |> 
  filter(subject_id == 10063848)

#need admit time to do that
admission_info <- read_csv("mimic/hosp/admissions.csv.gz",
                           col_select = c(subject_id, admittime)) |> 
  filter(subject_id == 10063848)

#AGE
patient_real_age <- left_join(patient_info, admission_info, 
                        by = "subject_id") |>mutate(calculated_age = anchor_age 
                                        + (year(admittime) - anchor_year))

print(patient_real_age)
```

Ok, so patient 10063848 is a 75 year old Female.

```{r}
#what about their race tho
patient_demographic <- read_csv("mimic/hosp/admissions.csv.gz",
    col_select = c(subject_id,race)) |>
       filter(subject_id ==10063848)
print(patient_demographic)
```

Ok so this patient was admitted a few times but our patient is a 75 year-old white female.

```{r}
patient_diagnoses <- read_csv("mimic/hosp/diagnoses_icd.csv.gz") |>
  filter(subject_id == 10063848, seq_num <= 3)

diagnoses_descriptions <- read_csv(
  "mimic/hosp/d_icd_diagnoses.csv.gz"
)

top_diagnoses <- left_join(
  patient_diagnoses,
  diagnoses_descriptions,
  by = c("icd_code", "icd_version")
) |>
  head(3)

print(top_diagnoses)
```

The patient was admitted 3 separate times, so I selected the first 3 printed and filtered with head(3). Or else, we would be looking at 9 diagnoses (3x3).

So seq1 is "Intestinal adhesions \[bands\] with obstruction (postinfection)", seq2 is "Acute respiratory failure with hypoxia" and seq3 is "Von Willebrand disease."

```{r}
transfer_information <-read_csv("mimic/hosp/transfers.csv.gz") |>
  filter(subject_id == 10063848)

print(transfer_information)
```

```{r}
#using parquet generated in hw2
patient_labs <- arrow::open_dataset("labevents_pq") |>
  filter(subject_id == 10063848) |>
  collect()
print(patient_labs)

# what we will use for charttime
#keep all admittance data here becuase we want patient's entire trajectory
#only filtered when we needed only 3 top diagnoses
```

```{r}
transfer_information <- transfer_information |>
  mutate(is_icu = if_else(str_detect(careunit, "ICU|CCU"), "Yes", "No"))

print(transfer_information)

#Yay! Added ICU column
```

```{r}
#similar left join as patient diagnoses but with procedures
patient_procedures <- read_csv("mimic/hosp/procedures_icd.csv.gz") |>
  filter(subject_id == 10063848)

procedure_descriptions <-read_csv("mimic/hosp/d_icd_procedures.csv.gz") 

patient_comp_procedures <- left_join(patient_procedures, procedure_descriptions,
                   by = c("icd_code", "icd_version"))

print(patient_comp_procedures)
```

```{r}
# 1. Fix the procedure dates and shorten titles FIRST
patient_comp_procedures <- patient_comp_procedures |>
  mutate(
    charttime = as_datetime(chartdate),
    short_title = str_trunc(long_title, width = 30)
  )
```

```{r}
# THE PLOT! with all the combined data!
trajectory_plot <- ggplot() +
  # Layer 1: ADT history 
  geom_segment(
    data = transfer_information |> filter(eventtype != "discharge"),
    mapping = aes(
      x = intime,
      xend = outtime,
      y = "ADT",
      yend = "ADT",
      color = careunit,
      linewidth = str_detect(careunit, "ICU|CCU") 
    )
  ) +
  # Layer 2: Lab Events 
  geom_point(
    data = patient_labs,
    mapping = aes(x = charttime, y = "Lab"),
    shape = 3, 
    size = 2,
    alpha = 0.5 
  ) +
  # Layer 3: Procedures 
  geom_point(
    data = patient_comp_procedures,
    mapping = aes(x = charttime, y = "Procedure", shape = short_title),
    size = 3
  ) +
  scale_y_discrete(limits = c("Procedure", "Lab", "ADT")) +
  labs(
    title = "Patient 10063848, F, 75 years old, white",
    subtitle = "Intestinal adhesions [bands] with obstruction(postinfection)
Acute respiratory failure with hypoxia
Von Willebrand disease", 
    x = "Calendar Time",
    y = NULL, 
    color = "Care Unit",
    shape = "Procedure"
  ) +
  guides(linewidth = "none") +
  theme_bw() 

print(trajectory_plot)
```

**DO THIS: For reproducibility, make the Parquet folder `labevents_pq` available at the current working directory `hw3`, for example, by a symbolic link. Make your code reproducible!!!!!!!**

------------------------------------------------------------------------

### 1.2 ICU Stays

ok so i need to identify icu stays and look for vitals during those times and plot it.....

```{r}
icu_stays <- transfer_information |>
  filter(is_icu == "Yes") |>
  select(subject_id, hadm_id, careunit, intime, outtime) |>
  mutate(stay_id = row_number())

print(icu_stays)
#we had already filtered icu earlier so need to extract that here
```

```{r, cache=TRUE}
patient_vitals <- read_csv(
  "mimic/icu/chartevents.csv.gz",
  col_select = c(
    subject_id,
    hadm_id,
    charttime,
    itemid,
    valuenum
  )
) |>
filter(subject_id == 10063848)
```

```{r, cache=TRUE}
vital_dict <- read_csv(
  "mimic/icu/d_items.csv.gz",
  col_select = c(
    itemid,
    label,
    abbreviation
  )
)

patient_vitals <- patient_vitals |>
left_join(vital_dict,by="itemid")
```

```{r}
patient_vitals <- patient_vitals |>
filter(
abbreviation %in%
c("HR","NBPs","NBPd","RR","Temperature")
)
```

```{r}
icu_stays <- transfer_information |>
filter(is_icu=="Yes") |>
select(
hadm_id,
intime,
outtime
) |>
mutate(stay_id=row_number())
```

```{r}
icu_vitals <- patient_vitals |>
inner_join(icu_stays,by="hadm_id") |>
filter(
charttime>=intime,
charttime<=outtime
)
```

```{r}
icu_vitals <- icu_vitals |>
mutate(stay_id = as.character(stay_id))
ggplot(
  icu_vitals,
  aes(
    x = charttime,
    y = valuenum,
    color = abbreviation
  )
) +
geom_line() +
geom_point() +
facet_grid(
  abbreviation ~ stay_id,
  scales = "free_y"
) +
labs(
  title = "Patient 10063848 ICU stays - Vitals",
  x = "Calendar Time",
  y = NULL,
  color = "Vital"
) +
theme_bw()
```

------------------------------------------------------------------------

## Q2 ICU Stays

```{bash}
gzcat < ~/mimic/icu/icustays.csv.gz | head
```

### 2.1 Ingestion

```{r}
icustays_tble <- read_csv(
"~/mimic/icu/icustays.csv.gz"
)

icustays_tble
```

### 2.2

```{r}
n_distinct(icustays_tble$subject_id)
```

There are 65,366 unique subject ids.

```{r}
icustays_tble |>
count(subject_id) |>
summarise(max_stays = max(n))
```

Yes, a subject can have more that one ICU stay. This is the mac number of stays for one person.

```{r}
icustays_tble |>
count(subject_id) |>
count(n)
```

The first table shows the maximum number of ICU stays for a single subject.\

The second table shows how many subjects had each number of ICU stays.

```{r}
stays_per_subject <- icustays_tble |>
count(subject_id)

ggplot(stays_per_subject, aes(x = n)) +
geom_histogram(binwidth = 1, boundary = 0) +
labs(
x = "Number of ICU stays per subject",
y = "Number of subjects",
title = "Distribution of ICU stays per subject"
) +
theme_bw()
```

This graph shows the distribution of ICU stays per subject. Most subjects have one ICU stay, with fewer subjects having multiple stays.

------------------------------------------------------------------------

## Q3 Admissions Data

```{bash}
gzcat < ~/mimic/hosp/admissions.csv.gz | head

```

### 3.1 Ingestion

```{r}
admissions_tble <- read_csv(
"~/mimic/hosp/admissions.csv.gz"
)

admissions_tble
```

### 3.2 Summary and Visualization

```{r}
admissions_per_patient <- admissions_tble |>
  count(subject_id)

ggplot(admissions_per_patient, aes(x = n)) +
  geom_histogram(binwidth = 1, boundary = 0) +
  labs(
    x = "Number of admissions per patient",
    y = "Number of patients",
    title = "Admissions per patient"
  ) +
  theme_bw()

```

Most patients have only one hospital admission. A smaller number have multiple admissions, and very few patients have many admissions.

```{r}
admissions_tble |>
  mutate(hour = lubridate::hour(admittime)) |>
  ggplot(aes(x = hour)) +
  geom_histogram(binwidth = 1) +
  labs(
    x = "Admission hour",
    y = "Count",
    title = "Hospital admissions by hour"
  ) +
  theme_bw()
```

Admissions occur throughout the day, with higher frequencies in the afternoon and evening hours( this is a 24 hour clock time). There is also a huge spike at midnight, which may reflect rounding or administrative recording practices.

```{r}
admissions_tble |>
  mutate(minute = lubridate::minute(admittime)) |>
  ggplot(aes(x = minute)) +
  geom_histogram(binwidth = 1) +
  labs(
    x = "Admission minute",
    y = "Count",
    title = "Hospital admissions by minute"
  ) +
  theme_bw()

```

Admission minutes show spikes at round values such as 0 and 30. This suggests admission times are often recorded approximately rather than exactly( and around 45).

```{r}
admissions_tble |>
  mutate(
    los_days = as.numeric(dischtime - admittime, units = "days")
  ) |>
  ggplot(aes(x = los_days)) +
  geom_histogram() +
  labs(
    x = "Length of stay (days)",
    y = "Count",
    title = "Length of hospital stay"
  ) +
  theme_bw()

```

Most hospital stays are short, with fewer long stays. The distribution is right-skewed, meaning a small number of patients stay much longer than average.

------------------------------------------------------------------------

## Q4 Patients Data

```{bash}
zcat < ~/mimic/hosp/patients.csv.gz | head
```

### 4.1 Ingestion

```{r}
patients_tble <- read_csv(
"~/mimic/hosp/patients.csv.gz"
)

patients_tble
```

### 4.2 Summary and Visualization

```{r}
# Q4.2 Patients summary

patients_tble |>
  count(gender) |>
  ggplot(aes(x = gender, y = n)) +
  geom_col() +
  labs(
    title = "Gender distribution",
    x = "Gender",
    y = "Count"
  )

patients_tble |>
  ggplot(aes(x = anchor_age)) +
  geom_histogram(bins = 40) +
  labs(
    title = "Age distribution",
    x = "Age",
    y = "Count"
  )

```

The patient population in this dataset is relatively balanced between genders, with neither group significantly outnumbering the other.T here is a huge spike on the far left (younger patients) and another broad hump in the middle-age to elderly range. The first spike is likely newborns and the second spike is in 50-80.

------------------------------------------------------------------------

## Q5 Lab Results

```{bash}
gzcat < ~/mimic/hosp/labevents.csv.gz | head
```

```{bash}
gzcat < ~/mimic/hosp/d_labitems.csv.gz | head
```

```{r}
labevents <- open_dataset("labevents_pq")

labs_needed <- c(
50862, 50912, 50971,
50983, 50902, 50882,
51221, 51301, 50931
)

labs_small <- labevents |>
  filter(itemid %in% labs_needed) |>
  select(subject_id, itemid, storetime, valuenum) |>
  collect()
```

```{r cache=TRUE}
labs_last <- labs_small |>
  inner_join(icustays_tble, by="subject_id") |>
  filter(storetime <= intime) |>
  group_by(stay_id,itemid) |>
  slice_max(storetime,n=1) |>
  ungroup()

```

```{r}
labs_named <- labs_last |>
  mutate(
    lab = case_when(
      itemid == 50862 ~ "albumin",
      itemid == 50912 ~ "creatinine",
      itemid == 50971 ~ "potassium",
      itemid == 50983 ~ "sodium",
      itemid == 50902 ~ "chloride",
      itemid == 50882 ~ "bicarbonate",
      itemid == 51221 ~ "hematocrit",
      itemid == 51301 ~ "wbc",
      itemid == 50931 ~ "glucose"
    )
  )
labevents_tble <- labs_named |>
  select(subject_id, stay_id, lab, valuenum) |>
  tidyr::pivot_wider(
    names_from = lab,
    values_from = valuenum,
    values_fn = mean
  )
```

```{r}
labevents_tble
```

yay!

------------------------------------------------------------------------

## Q6 Vitals from Charted Events

```{bash}
gzcat < ~/mimic/icu/chartevents.csv.gz | head
```

```{bash}
gzcat < ~/mimic/icu/d_items.csv.gz | head
```

```{r}
chartevents <- open_dataset("chartevents_pq")

vitals_needed <- c(
  220045,
  220179,
  220180,
  223761,
  220210
)

chartevents_small <- chartevents |>
  filter(itemid %in% vitals_needed) |>
  select(
    subject_id,
    stay_id,
    storetime,
    itemid,
    valuenum
  ) |>
  mutate(stay_id = as.numeric(stay_id))

chartevents_joined <- chartevents_small |>
  inner_join(icustays_tble, by = "stay_id") |>
  collect()

chartevents_first <- chartevents_joined |>
  filter(storetime >= intime) |>
  group_by(stay_id, itemid) |>
  slice_min(storetime, n = 1, with_ties = FALSE)

chartevents_tble <- chartevents_first |>
  select(stay_id, itemid, valuenum) |>
  pivot_wider(
    names_from = itemid,
    values_from = valuenum
  )

head(chartevents_tble)
```

```{r cache=TRUE}

chartevents_tble <- chartevents_tble |>
  rename(
    heart_rate = `220045`,
    systolic_bp = `220179`,
    diastolic_bp = `220180`,
    temperature_f = `223761`,
    respiratory_rate = `220210`
  )

chartevents_tble
```

------------------------------------------------------------------------

## Q7 Putting things together

```{r cache=TRUE}
mimic_icu_cohort <- icustays_tble |>

  left_join(
    admissions_tble,
    by = c("subject_id", "hadm_id")
  ) |>

  left_join(
    patients_tble,
    by = "subject_id"
  ) |>

  left_join(
    labevents_tble,
    by = c("subject_id", "stay_id")
  ) |>

  left_join(
    chartevents_tble,
    by = "stay_id"
  )

mimic_icu_cohort
```

## Q8 **Exploratory data analysis (EDA)**
