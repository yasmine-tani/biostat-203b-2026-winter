---
title: "biostat203bhw3"
format: html
editor: visual
author: Yasmine Tani; UID 406579988
---

# Biostatistics 203B - Homework 3

```{r}
sessionInfo()
```

```{r}
#loading necessary libraries
library(arrow)
library(gtsummary)
library(memuse)
library(pryr)
library(R.utils)
library(tidyverse)
library(stringr)
library(ggplot2)
```

```{r}
memuse::Sys.meminfo()
```

## Q1 Visualizing Patient Trajectory

### 1.1 ADT History (Admission-Discharge-Transfer)

```{r}
#patient dem for title, have to compute age manually according to TA
patient_info <- read_csv("mimic/hosp/patients.csv.gz",
            col_select = c(subject_id, anchor_age, anchor_year, gender)) |> 
  filter(subject_id == 10063848)

#need admit time to do that
admission_info <- read_csv("mimic/hosp/admissions.csv.gz",
                           col_select = c(subject_id, admittime)) |> 
  filter(subject_id == 10063848)

#AGE
patient_real_age <- left_join(patient_info, admission_info, 
                        by = "subject_id") |>mutate(calculated_age = anchor_age 
                                        + (year(admittime) - anchor_year))

print(patient_real_age)
```

Ok, so patient 10063848 is a 75 year old Female.

```{r}
#what about their race tho
patient_demographic <- read_csv("mimic/hosp/admissions.csv.gz",
    col_select = c(subject_id,race)) |>
       filter(subject_id ==10063848)
print(patient_demographic)
```

Ok so this patient was admitted a few times but our patient is a 75 year-old white female.

```{r}
#still on title, want patient's top 3 diagnoses
patient_diagnoses <- read_csv("mimic/hosp/diagnoses_icd.csv.gz") |>
  filter(subject_id == 10063848, seq_num <=3) #for top 3 diagnoses

diagnoses_descriptions <-read_csv("mimic/hosp/d_icd_diagnoses.csv.gz") 
#d_ is for dictionary

top_diagnoses <- left_join(patient_diagnoses, diagnoses_descriptions,
                   by = c("icd_code", "icd_version")) |> head(3)

print(top_diagnoses)
```

The patient was admitted 3 separate times, so I selected the first 3 printed and filtered with head(3). Or else, we would be looking at 9 diagnoses (3x3).

So seq1 is "Intestinal adhesions \[bands\] with obstruction (postinfection)", seq2 is "Acute respiratory failure with hypoxia" and seq3 is "Von Willebrand disease."

```{r}
transfer_information <-read_csv("mimic/hosp/transfers.csv.gz") |>
  filter(subject_id == 10063848)

print(transfer_information)
```

```{r}
#using parquet generated in hw2
patient_labs <- arrow::open_dataset("labevents.parquet") |> 
  filter(subject_id == 10063848) |> 
  collect()
print(patient_labs)

# what we will use for charttime
#keep all admittance data here becuase we want patient's entire trajectory
#only filtered when we needed only 3 top diagnoses
```

```{r}
transfer_information <- transfer_information |>
  mutate(is_icu = if_else(str_detect(careunit, "ICU|CCU"), "Yes", "No"))

print(transfer_information)

#Yay! Added ICU column
```

```{r}
#similar left join as patient diagnoses but with procedures
patient_procedures <- read_csv("mimic/hosp/procedures_icd.csv.gz") |>
  filter(subject_id == 10063848)

procedure_descriptions <-read_csv("mimic/hosp/d_icd_procedures.csv.gz") 

patient_comp_procedures <- left_join(patient_procedures, procedure_descriptions,
                   by = c("icd_code", "icd_version"))

print(patient_comp_procedures)
```

```{r}
# 1. Fix the procedure dates and shorten titles FIRST
patient_comp_procedures <- patient_comp_procedures |>
  mutate(
    charttime = as_datetime(chartdate),
    short_title = str_trunc(long_title, width = 30)
  )
```

```{r}
# THE PLOT! with all the combined data!
trajectory_plot <- ggplot() +
  # Layer 1: ADT history 
  geom_segment(
    data = transfer_information |> filter(eventtype != "discharge"),
    mapping = aes(
      x = intime,
      xend = outtime,
      y = "ADT",
      yend = "ADT",
      color = careunit,
      linewidth = str_detect(careunit, "ICU|CCU") 
    )
  ) +
  # Layer 2: Lab Events 
  geom_point(
    data = patient_labs,
    mapping = aes(x = charttime, y = "Lab"),
    shape = 3, 
    size = 2,
    alpha = 0.5 
  ) +
  # Layer 3: Procedures 
  geom_point(
    data = patient_comp_procedures,
    mapping = aes(x = charttime, y = "Procedure", shape = short_title),
    size = 3
  ) +
  scale_y_discrete(limits = c("Procedure", "Lab", "ADT")) +
  labs(
    title = "Patient 10063848, F, 75 years old, white",
    subtitle = "Intestinal adhesions [bands] with obstruction(postinfection)
Acute respiratory failure with hypoxia
Von Willebrand disease", 
    x = "Calendar Time",
    y = NULL, 
    color = "Care Unit",
    shape = "Procedure"
  ) +
  guides(linewidth = "none") +
  theme_bw() 

print(trajectory_plot)
```
